<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div class="buttons">
            <button id="save">save</button>
            <button id="undo">undo</button>
            <button id="clear">reset</button>
            <h3>choose shape</h3>
            <div class="shapeButtons">
                <button id="shapeButton" class="active" value="polygon">draw walls</button>
                <button id="shapeButton" value="marker">add markers</button>
                <button id="shapeButton" value="doorway">add doorways</button>
            </div>
        </div>
        <h1></h1>
        <div id="myDrawing"></div>
    </div>

    <script src="svgfolder.js/dist/svg.js"></script>
    <script src="svg.drawfolder.js/dist/svg.draw.js"></script>
    <script>
        let parentDiv = document.getElementById('myDrawing');
        let canvas = new SVG('myDrawing')
            .size('100%', '100%')
            .polygon()
            .draw({ snapToGrid: 20 })
            .attr('stroke-width', 1)
            .attr('fill', 'none');
        let currentShapeType = 'polygon';
        let drawingPoly = true;
        let rotation = 180;
        let shapes = [];

        const checkMouseCoordinates = (event) => {
            let x = event.clientX;
            let y = event.clientY;
            let containerBoundingRect = document.getElementById('myDrawing').getBoundingClientRect();
            const { top, right, bottom, left } = containerBoundingRect;
            // make sure that the click is inside the bounds of the frame:
            if (x > left && x < right && y > top && y < bottom) {
                let offsetX = containerBoundingRect.x;
                let offsetY = containerBoundingRect.y;
                switch (currentShapeType) {
                    case 'marker':
                        createNewMarker(x, offsetX, y, offsetY);
                        return;
                    case 'polygon':
                        if (!drawingPoly && shapes.length) {
                            drawingPoly = true;
                            createNewPolygon()
                        }
                        return;
                    case 'doorway':
                        createDoorway(x, offsetX, y, offsetY);
                        return;
                }
            }
        }
        document.addEventListener("click", checkMouseCoordinates);

        // handle clicking the shape buttons
        let shapeButtons = document.querySelectorAll('button[id=shapeButton]');
        shapeButtons.forEach(btn => {
            btn.addEventListener('click', event => {
                const value = event.target.value
                // remove active class from other buttons if different one is clicked
                if (currentShapeType != value) {
                    shapeButtons.forEach(btn => btn.classList.remove('active'))
                }
                if (currentShapeType === value) return;
                currentShapeType = value;
                document.querySelector(`button[value=${currentShapeType}`).classList.toggle('active');
            })
        })

        // helper to create a new div for a shape
        const createNewDiv = () => {
            let newDiv = document.createElement('div');
            newDiv.id = shapes.length + 1;
            parentDiv.appendChild(newDiv);
            return newDiv;
        }

        const createNewMarker = (x, offsetX, y, offsetY) => {
            drawingPoly = false;
            if (shapes.length === 0) parentDiv.innerHTML = '';
            let newDiv = createNewDiv();
            let newMarker = new SVG(newDiv.id)
                .size('100%', '100%')
                .circle()
                .draw()
                .radius(8)
                .move((x - offsetX) - 10, (y - offsetY) - 10)
                .attr('fill', '#5D69C5')
            newMarker.draw('stop');
            shapes.push(newMarker);
        }

        const createNewPolygon = () => {
            drawingPoly = true;
            let newDiv = createNewDiv();
            newPoly = new SVG(newDiv.id)
                .size('100%', '100%')
                .polygon()
                .draw({ snapToGrid: 20 })
                .attr('stroke-width', 1)
                .attr('fill', 'none')
            newPoly.on('drawstart', () => {
                document.addEventListener('keydown', (event) => {
                    if (event.keyCode == 13) {
                        newPoly.draw('done');
                        shapes.push(newPoly);
                        drawingPoly = false
                    }
                });
            });
        }


        const createDoorway = (x, offsetX, y, offsetY) => {
            drawingPoly = false;
            let trueX = (x - offsetX) - 10;
            let trueY = (y - offsetY) - 10;
            if (shapes.length === 0) parentDiv.innerHTML = '';
            let newDiv = createNewDiv();
            let newDoorway = new SVG(newDiv.id)
                .size('100%', '100%')
                .path("M0,50 a1,1 0 0,0 20,0")
                .rotate(rotation, x - offsetX - 1, trueY + 5)
                .move(trueX, trueY)
                .attr({
                    fill: 'none',
                    strokeWidth: 1,
                    stroke: '#000'
                })
            shapes.push(newDoorway);
        }

        document.getElementById('undo').addEventListener('click', () => {
            if (shapes.length) undoShape();
        })
        document.getElementById('clear').addEventListener('click', () => resetCanvas())

        const undoShape = () => {
            console.log(shapes)
            let shapeToUndo = shapes[shapes.length - 1];
            document.getElementById(shapeToUndo.node.id).remove();
            shapes.splice(shapes.indexOf(shapes.length - 1), 1)
            if (!shapes.length) {
                resetCanvas();
            }
        }

        const resetCanvas = () => {
            parentDiv.innerHTML = '';
            canvas = new SVG('myDrawing')
                .size('100%', '100%')
                .polygon()
                .draw({ snapToGrid: 20 })
                .attr('stroke-width', 1)
                .attr('fill', 'none');
            shapeButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector('button[value=polygon]').classList.add('active');
            currentShapeType = 'polygon';
            shapes = [];
        }

        canvas.on('drawstart', () => {
            document.addEventListener('keydown', (event) => {
                if (event.keyCode == 13) {
                    canvas.draw('done');
                    shapes.push(canvas);
                    drawingPoly = false;
                }
            });
        });

    </script>
</body>

</html>