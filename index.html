<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div class="buttons">
            <button id="save">save</button>
            <button id="undo">undo</button>
            <button id="clear">reset</button>
            <div class="shapeButtons">
                <button id="shapeButton" value="polygon">draw walls</button>
                <button id="shapeButton" value="rect">draw rectangle</button>
                <button id="shapeButton" value="marker">add markers</button>
                <button id="shapeButton" value="doorway">add doorways</button>
            </div>
        </div>
        <div id="drawing"></div>
    </div>

    <script src="svg.js/dist/svg.js"></script>
    <script src="svg.draw.js/dist/svg.draw.js"></script>
    <script src="dom-to-image/dist/dom-to-image.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            let activeShape;

            let shapes = [];

            let shape, drawing = new SVG('drawing').size('100%', '100%');

            let buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.addEventListener('click', event => {
                    const value = event.target.value
                    const id = event.target.id
                    // remove active class from other buttons if different one is clicked
                    if (activeShape != value) {
                        buttons.forEach(btn => btn.classList.remove('active'))
                    }
                    activeShape = value;

                    switch (id) {
                        case 'undo':
                            undoShape();
                            return;
                        case 'reset':
                            resetCanvas();
                            return;
                        case 'save':
                            saveCanvas();
                            return;
                    }
                    if (activeShape) document.querySelector(`button[value=${activeShape}`).classList.toggle('active');
                    switch (value) {
                        case 'polygon':
                            shape = drawing.polygon().draw({ snapToGrid: 20 }).attr('stroke-width', 1).attr('fill', 'none');
                            shape.on('drawstart', () => {
                                document.addEventListener('keydown', function (e) {
                                    if (e.keyCode == 13) {
                                        shapes.push(shape);
                                        shape.draw('stop');
                                        document.querySelector(`button[value=${activeShape}]`).classList.toggle('active');
                                        activeShape = null;
                                    }
                                });
                            })
                            return;
                        case 'marker':
                            shape = drawing.circle().draw({ snapToGrid: 20 }).attr('stroke-width', 1).attr('fill', 'none');
                            return;
                        case 'doorway':
                            shape = drawing.attr('stroke-width', 1).attr('fill', 'none');
                            return;
                        case 'rect':
                            shape = drawing.rect().attr('stroke-width', 1).attr('fill', 'none');
                            return;
                    }
                })
            })

            drawing.on('mousedown', (e) => {
                if (activeShape === 'rect') {
                    shape && shape.draw(e, { snapToGrid: 20 });
                }
            });

            drawing.on('mouseup', (e) => {
                if (shape && activeShape === 'rect') {
                    shape.draw('stop');
                    // get svg string
                    // console.log(shape.svg());
                    document.querySelector(`button[value=${activeShape}]`).classList.toggle('active');
                    console.log(`pushing ${shape.type}`)
                    shapes.push(shape);
                    shape = null;
                    activeShape = null;
                }
                document.removeEventListener('keydown', () => { })
            });

            drawing.on('click', (event) => {
                let { offsetX, offsetY } = event;
                if (activeShape === 'marker' || activeShape === 'doorway') {
                    placeIconAtCursor(offsetX - 10, offsetY - 10);
                    return;
                }
            });

            const placeIconAtCursor = (x, y) => {
                if (activeShape === 'marker') {
                    shape = drawing
                        .circle()
                        .draw()
                        .radius(10)
                        .move(x, y)
                        .attr({
                            'fill': '#5D69C5',
                            'stroke-width': 0,
                            stroke: '#000'
                        })
                    console.log(`pushing ${shape.type}`)
                    shapes.push(shape);
                    shape.draw('stop');
                    shape = null;
                    return;
                }
                if (activeShape === 'doorway') {
                    shape = drawing
                        .path("M0,50 a1,1 0 0,0 20,0")
                        .rotate(180, x + 9, y + 5)
                        .move(x, y)
                        .attr({
                            fill: 'none',
                            'stroke-width': 1.5,
                            stroke: '#000'
                        })
                    console.log(`pushing ${shape.type}`)
                    shapes.push(shape);
                    shape = null;
                    return;
                }
            }

            // undo the most recent shape
            const undoShape = () => {
                if (!shapes.length) {
                    return;
                }
                let shapeToUndo = shapes[shapes.length - 1];
                document.getElementById(shapeToUndo.node.id).remove();
                shapes.splice(shapes.indexOf(shapes.length - 1), 1)
            }

            // cleanup the canvas
            const resetCanvas = () => {
                document.getElementById('drawing').innerHTML = '';
                buttons.forEach(btn => btn.classList.remove('active'));
            }

            // export the current canvas as a SVG file
            const saveCanvas = () => {
                if (shapes.length) {
                    domtoimage.toSvg(document.getElementById('drawing'), { style: { position: 'absolute', top: 0, left: 0 } })
                        .then(function (dataUrl) {
                            var link = document.createElement('a');
                            link.href = dataUrl;
                            link.download = 'site-map.svg';
                            link.click();
                        });
                }
            }
        });
    </script>
</body>

</html>